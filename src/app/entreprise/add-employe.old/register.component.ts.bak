import { Component, OnInit } from '@angular/core';
import { NgForm } from '@angular/forms';
import { Router } from '@angular/router';
import { EmployeeService } from '../../_services/employee.service';
import { AuthService } from '../../_services/auth.service';
import { IEmployee } from '../../_models/employee.interface';
import { JwtHelperService } from '@auth0/angular-jwt';
import { EntrepriseService } from 'src/app/_services/company.service';

@Component({
  selector: 'app-register',
  templateUrl: './register.component.html',
  styleUrls: ['./register.component.scss'],
  providers: [EmployeeService, AuthService, EntrepriseService]
})
export class RegisterComponent implements OnInit {
  constructor(
    private _employeService: EmployeeService,
    private _entrepriseService: EntrepriseService,
    private _router: Router,
    private _jwtHelperService: JwtHelperService,
    private _authService: AuthService
  ) {}

  private newEmployee: IEmployee;
  private actuelEntreprise: any;
  loginExist = false;

  ngOnInit() {
    // console.log(this._authService.currentEmployeValue);
    const token = this._authService.getToken();
    if (token) {
      const decodeToken = this._jwtHelperService.decodeToken(token);
      // console.log('Companyid : ' + decodeToken.subject);
      this._entrepriseService.getEntrepriseName(decodeToken.subject).subscribe(
        res => {
          this.actuelEntreprise = res;
          console.log(this.actuelEntreprise);
        },
        err => {
          console.log('erreur :' + err);
        }
      );
    } else {
      this.actuelEntreprise = '';
    }
  }

  private donneesFormulaire(form: NgForm) {
    this.newEmployee = form.value;
    console.log('actuel entreprise : ' + this.actuelEntreprise.entreprise);
    console.log('donnÃ©e formulaire :');
    console.log(this.newEmployee);
    this.ajouterEmploye(this.newEmployee);
  }

  ajouterEmploye(newEmploye: any) {
    newEmploye.entreprise = this.actuelEntreprise.entreprise;
    this._employeService.addNewEmployee(newEmploye).subscribe(
      res => {
        console.log(res);
        this._router.navigate(['mesEmployes']);
      },
      err => console.log(err)
    );
  }

  focusOutFunction(event: string) {
    this.loginExist = false;
    if (event['path'][0].value) {
      const email = event['path'][0].value;
      this._entrepriseService.emailExist(email).subscribe((res: any) => {
        console.log(res);
        if (res.message === 'err') {
          this.loginExist = true;
        }
      });
    }
  }

  // openCity(evt, cityName) {
  //   let i, tabcontent, tablinks;
  //   tabcontent = document.getElementsByClassName('tabcontent');

  //   for (i = 0; i < tabcontent.length; i++) {
  //     tabcontent[i].style.display = 'none';
  //   }

  //   tablinks = document.getElementsByClassName('tablinks');

  //   for (i = 0; i < tablinks.length; i++) {
  //     tablinks[i].className = tablinks[i].className.replace(' active', '');
  //   }

  //   document.getElementById(cityName).style.display = 'block';
  //   evt.currentTarget.className += ' active';
  // }
}
